{"version":3,"file":"bulkupload.min.js","sources":["../src/bulkupload.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Bulk upload JavaScript module for Videoassessment\n *\n * @module     mod_videoassessment/bulkupload\n * @package\n * @copyright  2024 Don Hinkleman (hinkelman@mac.com)\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['jquery', 'core/log'], function ($, log) {\n\n    const PROGRESS_INTERVAL = 1000;\n    const conf = { parallels: 2 };\n    const str = {\n        error: \"Error\",\n        queued: \"Queued\",\n        uploading: \"Uploading\",\n        converting: \"Converting\",\n        complete: \"Complete\"\n    };\n\n    /**\n     * DOM helper to get element by ID.\n     * @param {string} id The element ID.\n     * @return {HTMLElement|null} The DOM element.\n     */\n    function get(id) {\n        return document.getElementById(id);\n    }\n\n    /**\n     * Create a text node.\n     * @param {string} s The string for the text node.\n     * @return {Text} The text node.\n     */\n    function text(s) {\n        return document.createTextNode(s);\n    }\n\n    /**\n     * Clear all child nodes from a DOM element.\n     * @param {HTMLElement} e The element to clear.\n     */\n    function clear(e) {\n        while (e.firstChild) {\n            e.removeChild(e.firstChild);\n        }\n    }\n\n    /**\n     * Make an AJAX request using XMLHttpRequest.\n     *\n     * @param {string} method HTTP method (get, post, etc).\n     * @param {string} url The target URL.\n     * @param {Object} params Parameters to send (key-value pairs).\n     * @param {Function} onComplete Callback on completion. Receives (responseText, status).\n     * @param {Function} [onProgress] Callback on progress. Receives (loaded, total).\n     */\n    function ajax(method, url, params, onComplete, onProgress) {\n        const data = new FormData();\n        if (params) {\n            Object.keys(params).forEach(key => data.append(key, params[key]));\n        }\n        if (typeof M !== \"undefined\" && M.cfg && M.cfg.sesskey) {\n            data.append(\"sesskey\", M.cfg.sesskey);\n        }\n        data.append(\"uniq\", Date.now());\n\n        const xhr = new XMLHttpRequest();\n        xhr.open(method, url, true);\n\n        if (onComplete) {\n            xhr.onreadystatechange = () => {\n                if (xhr.readyState === 4) {\n                    onComplete(xhr.responseText, xhr.status);\n                }\n            };\n        }\n        if (onProgress) {\n            (xhr.upload || xhr).addEventListener(\"progress\", (e) => {\n                onProgress(e.loaded || e.position, e.total || e.totalSize);\n            });\n        }\n        xhr.send(data);\n    }\n\n    /**\n     * Convert a file size in bytes to a human-readable string.\n     *\n     * @param {number} size The file size in bytes.\n     * @return {string} The human-readable size string.\n     */\n    function suffix(size) {\n        const units = [\"B\", \"KB\", \"MB\", \"GB\", \"TB\"];\n        let unit = units.shift();\n        while (size >= 1024 && units.length) {\n            size /= 1024;\n            unit = units.shift();\n        }\n        return `${size.toFixed(1)} ${unit}`;\n    }\n\n    class Status {\n        constructor(cell) { this.cell = cell; }\n        set(status) {\n            clear(this.cell);\n            this.cell.appendChild(text(str[status]));\n            this.cell.parentNode.className = status;\n        }\n    }\n    Status.ERROR = \"error\";\n    Status.QUEUED = \"queued\";\n    Status.UPLOADING = \"uploading\";\n    Status.CONVERTING = \"converting\";\n    Status.COMPLETE = \"complete\";\n\n    class Progress {\n        constructor(cell) {\n            const table = document.createElement(\"table\");\n            const row = table.insertRow(-1);\n            this.scales = Array.from({ length: 50 }, () => row.insertCell(-1));\n            cell.appendChild(table);\n        }\n        set(value) {\n            const n = Math.floor(this.scales.length * value / 100);\n            this.scales.forEach((scale, index) => {\n                scale.className = index < n ? \"done\" : \"\";\n            });\n        }\n    }\n\n    const bulkupload = {\n        setConfig(name, value) { conf[name] = value; },\n        setString(name, value) { str[name] = value; },\n\n        init(cmid) {\n            if (!window.File || !window.XMLHttpRequest || !window.FormData) {\n                log.debug('Unsupported browser for file upload.');\n                return;\n            }\n            $('#not_supported_browser').hide();\n\n            const tasklist = get(\"tasklist\");\n            let queue = [];\n            let running = 0;\n\n            const startAll = () => {\n                while (running < conf.parallels && queue.length) {\n                    queue.shift().start();\n                    running++;\n                }\n            };\n\n            const stopped = () => {\n                running--;\n                startAll();\n            };\n\n            class Task {\n                constructor(file, status, progress) {\n                    this.file = file;\n                    this.status = status;\n                    this.progress = progress;\n                }\n                isCode(code) { return /^[A-Za-z0-9\\-\\._]+$/.test(code); }\n                refresh(code) {\n                    ajax(\"post\", \"ajax.php\", { cmid, code }, (result, status) => {\n                        if (status !== 200 || !/^\\d+$/.test(result)) {\n                            this.status.set(Status.ERROR);\n                            stopped();\n                        } else {\n                            const percent = parseInt(result, 10);\n                            this.progress.set(percent);\n                            if (percent >= 100) {\n                                this.status.set(Status.COMPLETE);\n                                stopped();\n                            } else {\n                                setTimeout(() => this.refresh(code), PROGRESS_INTERVAL);\n                            }\n                        }\n                    });\n                }\n                start() {\n                    ajax(\"post\", \"ajax.php\", { cmid, file: this.file }, (result, status) => {\n                        if (status !== 200 || !this.isCode(result)) {\n                            this.status.set(Status.ERROR);\n                            stopped();\n                        } else {\n                            this.status.set(Status.CONVERTING);\n                            this.refresh(result);\n                        }\n                    }, (loaded, total) => {\n                        this.progress.set(100 * loaded / total);\n                    });\n                    this.status.set(Status.UPLOADING);\n                }\n            }\n\n            const add = (file) => {\n                const row = tasklist.insertRow(-1);\n                const addCell = (className) => {\n                    const cell = row.insertCell(-1);\n                    cell.className = className;\n                    return cell;\n                };\n                addCell(\"filename\").appendChild(text(file.name));\n                addCell(\"filesize\").appendChild(text(suffix(file.size)));\n                addCell(\"mimetype\").appendChild(text(file.type));\n                const status = new Status(addCell(\"status\"));\n                const progress = new Progress(addCell(\"progress\"));\n                queue.push(new Task(file, status, progress));\n                status.set(Status.QUEUED);\n                startAll();\n            };\n\n            // Wire up drag/drop:\n            const droparea = get(\"droparea\");\n            const cancel = (event) => {\n                event.preventDefault();\n                event.stopPropagation();\n                return false;\n            };\n            droparea.addEventListener(\"dragenter\", cancel, false);\n            droparea.addEventListener(\"dragover\", cancel, false);\n            droparea.addEventListener(\"drop\", (event) => {\n                Array.from(event.dataTransfer.files).forEach(file => add(file));\n                return cancel(event);\n            }, false);\n\n            // Wire up file input:\n            const fileToUpload = get(\"fileToUpload\");\n            fileToUpload.addEventListener(\"change\", (event) => {\n                Array.from(event.target.files).forEach(file => add(file));\n                return cancel(event);\n            }, false);\n\n            droparea.style.display = \"block\";\n        }\n    };\n\n    return bulkupload;\n});"],"names":["define","$","log","conf","parallels","str","error","queued","uploading","converting","complete","get","id","document","getElementById","text","s","createTextNode","ajax","method","url","params","onComplete","onProgress","data","FormData","Object","keys","forEach","key","append","M","cfg","sesskey","Date","now","xhr","XMLHttpRequest","open","onreadystatechange","readyState","responseText","status","upload","addEventListener","e","loaded","position","total","totalSize","send","Status","constructor","cell","set","firstChild","removeChild","clear","this","appendChild","parentNode","className","ERROR","QUEUED","UPLOADING","CONVERTING","COMPLETE","Progress","table","createElement","row","insertRow","scales","Array","from","length","insertCell","value","n","Math","floor","scale","index","setConfig","name","setString","init","cmid","window","File","debug","hide","tasklist","queue","running","startAll","shift","start","stopped","Task","file","progress","isCode","code","test","refresh","result","percent","parseInt","setTimeout","add","addCell","size","units","unit","toFixed","suffix","type","push","droparea","cancel","event","preventDefault","stopPropagation","dataTransfer","files","target","style","display"],"mappings":";;;;;;;;AAuBAA,wCAAO,CAAC,SAAU,aAAa,SAAUC,EAAGC,WAGlCC,KAAO,CAAEC,UAAW,GACpBC,IAAM,CACRC,MAAO,QACPC,OAAQ,SACRC,UAAW,YACXC,WAAY,aACZC,SAAU,qBAQLC,IAAIC,WACFC,SAASC,eAAeF,aAQ1BG,KAAKC,UACHH,SAASI,eAAeD,YAsB1BE,KAAKC,OAAQC,IAAKC,OAAQC,WAAYC,kBACrCC,KAAO,IAAIC,SACbJ,QACAK,OAAOC,KAAKN,QAAQO,SAAQC,KAAOL,KAAKM,OAAOD,IAAKR,OAAOQ,QAE9C,oBAANE,GAAqBA,EAAEC,KAAOD,EAAEC,IAAIC,SAC3CT,KAAKM,OAAO,UAAWC,EAAEC,IAAIC,SAEjCT,KAAKM,OAAO,OAAQI,KAAKC,aAEnBC,IAAM,IAAIC,eAChBD,IAAIE,KAAKnB,OAAQC,KAAK,GAElBE,aACAc,IAAIG,mBAAqB,KACE,IAAnBH,IAAII,YACJlB,WAAWc,IAAIK,aAAcL,IAAIM,UAIzCnB,aACCa,IAAIO,QAAUP,KAAKQ,iBAAiB,YAAaC,IAC9CtB,WAAWsB,EAAEC,QAAUD,EAAEE,SAAUF,EAAEG,OAASH,EAAEI,cAGxDb,IAAIc,KAAK1B,YAmBP2B,OACFC,YAAYC,WAAaA,KAAOA,KAChCC,IAAIZ,kBA7DOG,QACJA,EAAEU,YACLV,EAAEW,YAAYX,EAAEU,YA4DhBE,CAAMC,KAAKL,WACNA,KAAKM,YAAY5C,KAAKV,IAAIqC,eAC1BW,KAAKO,WAAWC,UAAYnB,QAGzCS,OAAOW,MAAQ,QACfX,OAAOY,OAAS,SAChBZ,OAAOa,UAAY,YACnBb,OAAOc,WAAa,aACpBd,OAAOe,SAAW,iBAEZC,SACFf,YAAYC,YACFe,MAAQvD,SAASwD,cAAc,SAC/BC,IAAMF,MAAMG,WAAW,QACxBC,OAASC,MAAMC,KAAK,CAAEC,OAAQ,KAAM,IAAML,IAAIM,YAAY,KAC/DvB,KAAKM,YAAYS,OAErBd,IAAIuB,aACMC,EAAIC,KAAKC,MAAMtB,KAAKc,OAAOG,OAASE,MAAQ,UAC7CL,OAAO5C,SAAQ,CAACqD,MAAOC,SACxBD,MAAMpB,UAAYqB,MAAQJ,EAAI,OAAS,aAKhC,CACfK,UAAUC,KAAMP,OAAS1E,KAAKiF,MAAQP,OACtCQ,UAAUD,KAAMP,OAASxE,IAAI+E,MAAQP,OAErCS,KAAKC,UACIC,OAAOC,OAASD,OAAOnD,iBAAmBmD,OAAO/D,qBAClDvB,IAAIwF,MAAM,wCAGdzF,EAAE,0BAA0B0F,aAEtBC,SAAWjF,IAAI,gBACjBkF,MAAQ,GACRC,QAAU,QAERC,SAAW,UACND,QAAU3F,KAAKC,WAAayF,MAAMlB,QACrCkB,MAAMG,QAAQC,QACdH,WAIFI,QAAU,KACZJ,UACAC,kBAGEI,KACF/C,YAAYgD,KAAM1D,OAAQ2D,eACjBD,KAAOA,UACP1D,OAASA,YACT2D,SAAWA,SAEpBC,OAAOC,YAAe,sBAAsBC,KAAKD,MACjDE,QAAQF,MACJrF,KAAK,OAAQ,WAAY,CAAEqE,KAAAA,KAAMgB,KAAAA,OAAQ,CAACG,OAAQhE,aAC/B,MAAXA,QAAmB,QAAQ8D,KAAKE,QAG7B,OACGC,QAAUC,SAASF,OAAQ,SAC5BL,SAAS/C,IAAIqD,SACdA,SAAW,UACNjE,OAAOY,IAAIH,OAAOe,UACvBgC,WAEAW,YAAW,IAAMnD,KAAK+C,QAAQF,OAtKhC,eA6JG7D,OAAOY,IAAIH,OAAOW,OACvBoC,aAaZD,QACI/E,KAAK,OAAQ,WAAY,CAAEqE,KAAAA,KAAMa,KAAM1C,KAAK0C,OAAQ,CAACM,OAAQhE,UAC1C,MAAXA,QAAmBgB,KAAK4C,OAAOI,cAI1BhE,OAAOY,IAAIH,OAAOc,iBAClBwC,QAAQC,eAJRhE,OAAOY,IAAIH,OAAOW,OACvBoC,cAKL,CAACpD,OAAQE,cACHqD,SAAS/C,IAAI,IAAMR,OAASE,eAEhCN,OAAOY,IAAIH,OAAOa,kBAIzB8C,IAAOV,aACH9B,IAAMsB,SAASrB,WAAW,GAC1BwC,QAAWlD,kBACPR,KAAOiB,IAAIM,YAAY,UAC7BvB,KAAKQ,UAAYA,UACVR,MAEX0D,QAAQ,YAAYpD,YAAY5C,KAAKqF,KAAKhB,OAC1C2B,QAAQ,YAAYpD,YAAY5C,cAlH5BiG,YACNC,MAAQ,CAAC,IAAK,KAAM,KAAM,KAAM,UAClCC,KAAOD,MAAMjB,aACVgB,MAAQ,MAAQC,MAAMtC,QACzBqC,MAAQ,KACRE,KAAOD,MAAMjB,wBAEPgB,KAAKG,QAAQ,eAAMD,MA2GgBE,CAAOhB,KAAKY,QACjDD,QAAQ,YAAYpD,YAAY5C,KAAKqF,KAAKiB,aACpC3E,OAAS,IAAIS,OAAO4D,QAAQ,WAC5BV,SAAW,IAAIlC,SAAS4C,QAAQ,aACtClB,MAAMyB,KAAK,IAAInB,KAAKC,KAAM1D,OAAQ2D,WAClC3D,OAAOY,IAAIH,OAAOY,QAClBgC,YAIEwB,SAAW5G,IAAI,YACf6G,OAAUC,QACZA,MAAMC,iBACND,MAAME,mBACC,GAEXJ,SAAS3E,iBAAiB,YAAa4E,QAAQ,GAC/CD,SAAS3E,iBAAiB,WAAY4E,QAAQ,GAC9CD,SAAS3E,iBAAiB,QAAS6E,QAC/BhD,MAAMC,KAAK+C,MAAMG,aAAaC,OAAOjG,SAAQwE,MAAQU,IAAIV,QAClDoB,OAAOC,UACf,GAGkB9G,IAAI,gBACZiC,iBAAiB,UAAW6E,QACrChD,MAAMC,KAAK+C,MAAMK,OAAOD,OAAOjG,SAAQwE,MAAQU,IAAIV,QAC5CoB,OAAOC,UACf,GAEHF,SAASQ,MAAMC,QAAU"}