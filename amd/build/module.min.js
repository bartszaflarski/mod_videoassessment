/**
 * Video assessment
 *
 * @package
 * @copyright  2024 Don Hinkleman (hinkelman@mac.com)
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("mod_videoassessment/module",["jquery","core/log","jqueryui"],(function($,log){return{mainInit(cmid){this.cmid=cmid,this.initVideoPreview()},videosInit(users,assocs){this.users=users,this.assocs=assocs,this.initVideoPreview(),$("#assocpanel").dialog({autoOpen:!1,width:450,height:420}).draggable({handle:".ui-dialog-titlebar"}),$(".videodel").on("click",(e=>{confirm(M.str.videoassessment.reallydeletevideo)||e.preventDefault()}))},peersInit(){},peersConfirmRandom:()=>confirm(M.str.videoassessment.reallyresetallpeers),assessInit(){},initVideoLinks(){$(".videolink").on("click",(e=>{e.preventDefault();const videoId=$(e.target).data("videoid")||$(e.target).parent().data("videoid");videoId?this.initVideoPreview(videoId):log.debug("Video ID not found")}))},initVideoPreview(){$("#videopreview").dialog({autoOpen:!1,modal:!0,width:480,height:420,close:()=>$("#videopreview").html("")}),$("#videopreviewnotice").dialog({autoOpen:!1,modal:!0,width:450,height:150})},videosUpdateAssocCell($div){let html='<select size="4"></select><select>';for(const user of this.users)html+="<option>".concat(user.fullname,"</option>");html+="</select>",$div.html(html)},videosShowVideoPreview(videoId){const src="videopreview.php?id=".concat(this.cmid,"&videoid=").concat(videoId,"&width=400&height=300"),html='<iframe class="videopreview" width="420" height="370" src="'.concat(src,'"></iframe>');$("#videopreview").html(html).dialog("open").dialog("moveToTop").focus()},initVideoTrainingPreview(){$(".show-training-video").on("click",(e=>{e.preventDefault();const videoId=$(e.currentTarget).data("videoid");this.videosShowVideoPreview(videoId)}))},videosShowVideoPreviewByUser(userId,timing){const src="videopreview.php?id=".concat(this.cmid,"&userid=").concat(userId,"&timing=").concat(timing,"&width=400&height=300"),html='<iframe class="videopreview" width="420" height="370" src="'.concat(src,'"></iframe>');$("#videopreview").html(html).dialog("open").dialog("moveToTop").focus()},videosVideoPreviewNotice(){let html='\n                <p class="popup-video-preview-heading">'.concat(M.str.mod_videoassessment.donotclickhere,'</p>\n                <div class="popup-video-preview">\n                    ').concat(M.str.mod_videoassessment.clickonthe,'\n                    <span class="button-firstassess-popup">').concat(M.str.mod_videoassessment.firstassess,"</span>\n                    ").concat(M.str.mod_videoassessment.or,'\n                    <span class="button-assessagain-popup">').concat(M.str.mod_videoassessment.assessagain,"</span>\n                </div>\n            ");$("#videopreviewnotice").html(html).dialog("open").dialog("moveToTop").focus()},videosShowAssocPanel(videoId){this.videoid=videoId,this.videosAssocPanelRefresh(),$("#id_videoid").val(this.videoid),$("#assocpanel").dialog("open").dialog("moveToTop").focus()},videosAssocPanelRefresh(){let filter=$("#studentfilter").val()||"unassociated",html="\n                <div>".concat(M.str.videoassessment.liststudents,'\n                    <select id="studentfilter">\n                        <option value="unassociated">').concat(M.str.videoassessment.unassociated,'</option>\n                        <option value="associated">').concat(M.str.videoassessment.associated,'</option>\n                        <option value="all">').concat(M.str.moodle.all,"</option>\n                    </select>\n                </div>\n                <div>\n                    ").concat(M.str.videoassessment.beforeafter,':\n                    <input type="radio" name="timing" id="timingbefore" checked="checked">\n                    <label for="timingbefore">').concat(M.str.videoassessment.before,'</label>\n                    <input type="radio" name="timing" id="timingafter">\n                    <label for="timingafter">').concat(M.str.videoassessment.after,"</label>\n                </div>\n            ");for(const[i,user]of Object.entries(this.users))if(this.shouldShowUser(filter,user)){const checked=user.assocvideos.includes(this.videoid)?"checked":"";html+='<div class="videoassoc-studentlist">\n                        <label><input type="checkbox" class="assocuser" value="'.concat(i,'" ').concat(checked,"/> ").concat(user.fullname,"</label>\n                    </div>")}html+='<button id="saveAssocBtn">'.concat(M.str.videoassessment.saveassociations,"</button>"),$("#assocpanel").html(html),$("#studentfilter").val(filter).on("change",(()=>this.videosAssocPanelRefresh())),$("#timingbefore").on("click",(()=>this.setTiming("before"))),$("#timingafter").on("click",(()=>this.setTiming("after"))),$("#saveAssocBtn").on("click",(()=>this.videosSaveAssociations()))},shouldShowUser:(filter,user)=>"all"===filter||"unassociated"===filter&&!user.assocvideos.length||"associated"===filter&&user.assocvideos.length,videosSaveAssociations(){const assocdata=[];$(".assocuser").each((function(){assocdata.push([$(this).val(),$(this).is(":checked")])})),$("#id_assocdata").val(JSON.stringify(assocdata)),$("#mform1").submit()},setTiming(value){$("#id_timing").val(value),log.debug("timing set ".concat(value))},reportCombineRubrics(){$(".report-rubrics").each(((index,node)=>{const $node=$(node);["before","after"].forEach((timing=>{const $teacherRubric=$node.find("#rubrics-".concat(timing,"teacher")),$selfRubric=$node.find("#rubrics-".concat(timing,"self")),$peerRubric=$node.find("#rubrics-".concat(timing,"peer")),$classRubric=$node.find("#rubrics-".concat(timing,"class"));if(!$teacherRubric.length)return;$teacherRubric.find(".remark").addClass("rubrictext-teacher"),$node.find("#heading-".concat(timing,"teacher")).hide();let countClass=$classRubric.find(".criterion").length?$node.find(".finalgrade .rubrictext-class").length:0,countPeer=$peerRubric.find(".criterion").length?$node.find(".finalgrade .rubrictext-peer").length:0,countTeacher=$teacherRubric.find(".criterion").length?$node.find(".finalgrade .rubrictext-teacher").length:0;$selfRubric.find(".criterion").length&&this.manageReportRubric($node,"self",["peer","teacher","class"],timing,countPeer,countClass,countTeacher),!$selfRubric.find(".remark .rubrictext-peer").length&&$peerRubric.find(".criterion").length&&($peerRubric.find(".criteria").length>1&&this.manageReportSameRubric($node,"peer",timing,countPeer,countClass,countTeacher),this.manageReportRubric($node,"peer",["teacher","class"],timing,countPeer,countClass,countTeacher)),$selfRubric.find(".remark .rubrictext-class").length||$peerRubric.find(".remark .rubrictext-class").length||$teacherRubric.find(".remark .rubrictext-class").length||!$classRubric.find(".criterion").length||$classRubric.find(".criteria").length>1&&this.manageReportSameRubric($node,"class",timing,countPeer,countClass,countTeacher),["self","peer","teacher","class"].forEach((gradertype=>{$node.find("#rubrics-".concat(timing).concat(gradertype," .criterion")).each(((_,crit)=>{$(crit).find(".level").each(((_,level)=>{const $level=$(level);$level.hasClass("checked")&&this.setStyleGradeCell($level,$(crit),gradertype,countPeer,countClass,countTeacher)}))}))}))}))}))},initPrint(){window.print()},initPublishVideos(){this.initCheckAll("#all-video-check",".video-check")},initDeleteVideos(){this.initCheckAll("#all-video-check",".video-check"),$("#id_submitbutton").on("click",(e=>{const count=$(".video-check:checked").length;if(0===count)return alert(M.str.mod_videoassessment.errorcheckvideostodelete),void e.preventDefault();const deleteMessage=M.str.videoassessment.confirmdeletevideos.replace("{$a}",count);confirm(deleteMessage)||e.preventDefault()}))},initCheckAll(allSelector,checkBoxesSelector){$(allSelector).on("click",(function(){$(checkBoxesSelector).prop("checked",$(this).is(":checked"))}))},manageGradesInit(){$(".deletegrade").on("click",(e=>{confirm(M.str.mod_videoassessment.confirmdeletegrade)||e.preventDefault()}))},manageReportRubric($node,targetGrade,graderTypes,timing,countPeer,countClass,countTeacher){graderTypes.forEach((graderType=>{$node.find("#rubrics-".concat(timing).concat(graderType," .criterion")).each(((_,crit)=>{const $crit=$(crit),critName=$crit.find(".description").html(),rowIndex=$crit.parent().children().index($crit),levelName=$crit.find(".checked .definition").html(),colIndex=$crit.find(".checked").parent().children().index($crit.find(".checked")),remark=$crit.find(".remark").html();let critFound=!1;$node.find("#rubrics-".concat(timing).concat(targetGrade," .criterion")).each(((index,tcrit)=>{const $tcrit=$(tcrit);if(!critFound&&$tcrit.find(".description").html()===critName&&index===rowIndex){critFound=!0;let levelFound=!1;$tcrit.find(".level").each(((index,level)=>{const $level=$(level);levelFound||($level.find(".definition").html()===levelName&&index===colIndex&&(levelFound=!0,this.fillGradeCell($level,graderType,countPeer,countClass,countTeacher)),$level.css("width","40px"))})),$tcrit.find(".remark").addClass("rubrictext-".concat(targetGrade)),$tcrit.find(".remark").append('<div class="rubrictext-'.concat(graderType,'">').concat(remark,"</div>")),$crit.hide().addClass("hidden-information");const height=$tcrit.find(".remark").outerHeight();$tcrit.find(".checked").outerHeight(height)}}))}));const criterionCount=$node.find("#rubrics-".concat(timing).concat(graderType," .criterion")).length,hiddenCriterionCount=$node.find("#rubrics-".concat(timing).concat(graderType," .hidden-information")).length,$comment=$node.find("#rubrics-".concat(timing).concat(graderType," .comment"));"rubrics-beforeclass"!=="rubrics-".concat(timing).concat(graderType)?(!$comment.length&&criterionCount<=hiddenCriterionCount&&$node.find("#rubrics-".concat(timing).concat(graderType)).hide(),$comment.length&&criterionCount<=hiddenCriterionCount&&$node.find("#rubrics-".concat(timing).concat(graderType," .pagebreak")).length&&$node.find("#rubrics-".concat(timing).concat(graderType," .pagebreak")).remove()):criterionCount<=hiddenCriterionCount&&($node.find("#rubrics-beforeclass .pagebreak").remove(),$node.find("#rubrics-beforeclass").prev().prev().find(".pagebreak").remove()),$node.find("#rubrics-beforetraining .pagebreak").remove(),$node.find("#heading-".concat(timing).concat(graderType)).hide()}))},manageReportSameRubric($node,graderType,timing,countPeer,countClass,countTeacher){$node.find("#rubrics-".concat(timing).concat(graderType," .criteria")).slice(1).each(((_,criteria)=>{const $criteria=$(criteria);$criteria.find(".criterion").each(((_,crit)=>{const $crit=$(crit),critName=$crit.find(".description").html(),rowIndex=$crit.parent().children().index($crit),levelName=$crit.find(".checked .definition").html(),colIndex=$crit.find(".checked").parent().children().index($crit.find(".checked")),remark=$crit.find(".remark").html();let critFound=!1;$node.find("#rubrics-".concat(timing).concat(graderType," .criteria:first .criterion")).each(((index,tcrit)=>{const $tcrit=$(tcrit);if(!critFound&&$tcrit.find(".description").html()===critName&&index===rowIndex){critFound=!0;let levelFound=!1;$tcrit.find(".level").each(((index,level)=>{const $level=$(level);levelFound||($level.find(".definition").html()===levelName&&index===colIndex&&(levelFound=!0,this.fillGradeCell($level,graderType,countPeer,countClass,countTeacher)),$level.css("width","40px"))})),$tcrit.find(".remark").addClass("rubrictext-".concat(graderType)),$tcrit.find(".remark").append('<div class="rubrictext-'.concat(graderType,'">').concat(remark,"</div>")),$crit.hide().addClass("hidden-information");const height=$tcrit.find(".remark").outerHeight();$tcrit.find(".checked").outerHeight(height)}}))}));const criterionCount=$node.find("#rubrics-".concat(timing).concat(graderType," .criterion")).length,hiddenCriterionCount=$node.find("#rubrics-".concat(timing).concat(graderType," .hidden-information")).length,$comment=$node.find("#rubrics-".concat(timing).concat(graderType," .comment"));"rubrics-beforeclass"!=="rubrics-".concat(timing).concat(graderType)?(!$comment.length&&criterionCount<=hiddenCriterionCount&&$node.find("#rubrics-".concat(timing).concat(graderType)).hide(),$comment.length&&criterionCount<=hiddenCriterionCount&&$node.find("#rubrics-".concat(timing).concat(graderType," .pagebreak")).length&&$node.find("#rubrics-".concat(timing).concat(graderType," .pagebreak")).remove()):criterionCount<=hiddenCriterionCount&&($node.find("#rubrics-beforeclass .pagebreak").remove(),$node.find("#rubrics-beforeclass").prev().prev().find(".pagebreak").remove()),$node.find("#rubrics-beforetraining .pagebreak").remove(),$node.find("#heading-".concat(timing).concat(graderType)).hide(),$criteria.hide()}))},setStyleGradeCell($level,$tcrit,graderType,countPeer,countClass,countTeacher){$level.css({border:"none","border-left":"1px solid #ddd","border-right":"1px solid #ddd"}),$tcrit.find(".checked").css("background","none"),this.fillGradeCell($level,graderType,countPeer,countClass,countTeacher)},fillGradeCell($level,graderType,countPeer,countClass,countTeacher){"self"===graderType?$level.find(".level-wrapper").append('<span class="inferiorlevelmarker rubrictext-'.concat(graderType,'">')+"".concat(M.str.videoassessment[graderType],"</span><br>")):"teacher"!==graderType||$level.find(".level-wrapper .rubrictext-teacher").length?"peer"!==graderType||$level.find(".level-wrapper .rubrictext-peer").length?"class"!==graderType||$level.find(".level-wrapper .rubrictext-class").length||$level.find(".level-wrapper").append('<span class="inferiorlevelmarker rubrictext-'.concat(graderType,'">')+"".concat(M.str.videoassessment[graderType]," (").concat(countClass,")</span><br>")):$level.find(".level-wrapper").append('<span class="inferiorlevelmarker rubrictext-'.concat(graderType,'">')+"".concat(M.str.videoassessment[graderType]," (").concat(countPeer,")</span><br>")):$level.find(".level-wrapper").append('<span class="inferiorlevelmarker rubrictext-'.concat(graderType,'">')+"".concat(M.str.videoassessment[graderType]," (").concat(countTeacher,")</span><br>"))}}}));

//# sourceMappingURL=module.min.js.map