/**
 * Peer assignment management for video assessment
 *
 * @module     mod_videoassessment/peer_assignment
 * @copyright  2024 Don Hinkleman (hinkelman@mac.com)
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define(["jquery"],(function($){let students={},peerAssignments={},isExisting=!1,cmid=0,sesskey="",usedpeers=0;function updateHiddenField(){const jsonValue=JSON.stringify(peerAssignments);let field=$("#id_peerassignments");0===field.length&&(field=$('input[name="peerassignments"]')),console.log("Updating hidden field. Field found:",field.length>0,"Value:",jsonValue),field.length>0?(field.val(jsonValue),console.log("Field value after update:",field.val())):(console.error("Hidden field not found! Trying to create one..."),$("form.mform").append('<input type="hidden" name="peerassignments" id="id_peerassignments" value="'+jsonValue.replace(/"/g,"&quot;")+'">'),console.log("Created hidden field with value:",jsonValue))}function addPeer(userid,peerid){console.log("Adding peer:",peerid,"to user:",userid),peerAssignments[userid]||(peerAssignments[userid]=[]),-1===peerAssignments[userid].indexOf(peerid)&&peerAssignments[userid].push(peerid),console.log("Current peerAssignments:",peerAssignments),renderPeersForUser(userid),updateHiddenField()}function removePeer(userid,peerid){if(peerAssignments[userid]){const index=peerAssignments[userid].indexOf(peerid);index>-1&&peerAssignments[userid].splice(index,1)}renderPeersForUser(userid),updateHiddenField()}function renderPeersForUser(userid){const container=$("#assigned-peers-"+userid);container.empty();const userPeers=peerAssignments[userid]||[];userPeers.forEach((function(peerid){if(students[peerid]){const badge=$('<span class="peer-badge badge badge-secondary mr-1 mb-1"></span>').attr("data-peerid",peerid).css({display:"inline-block",margin:"2px"});badge.text(students[peerid]+" ");const removeLink=$('<a href="#" class="remove-peer text-white">Ã—</a>').attr("data-userid",userid).attr("data-peerid",peerid).css({"text-decoration":"none","font-weight":"bold"});badge.append(removeLink),container.append(badge)}}));const select=$('select.add-peer-select[data-userid="'+userid+'"]');select.find("option").each((function(){const optionValue=parseInt($(this).val());optionValue&&userPeers.indexOf(optionValue)>-1?$(this).prop("disabled",!0):$(this).prop("disabled",!1)})),select.val("")}function assignRandomPeers(mode){let numPeers=parseInt($("#id_usedpeers").val())||usedpeers;numPeers<=0&&(numPeers=1);const studentIds=Object.keys(students).map(Number);studentIds.length<=numPeers?alert("Not enough students to assign "+numPeers+" peers each."):confirm("This will reset all peer assignments and assign "+numPeers+" random peer(s) to each student. Continue?")&&(peerAssignments={},studentIds.forEach((function(userid){peerAssignments[userid]=[];const availablePeers=studentIds.filter((function(id){return id!==userid}));for(let i=availablePeers.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[availablePeers[i],availablePeers[j]]=[availablePeers[j],availablePeers[i]]}peerAssignments[userid]=availablePeers.slice(0,numPeers)})),studentIds.forEach((function(userid){renderPeersForUser(userid)})),updateHiddenField())}return{init:function(params){$(function(){try{console.log("Peer assignment init called with params:",params),students=params.students||{},peerAssignments=params.existingPeers||{},isExisting=params.isExisting||!1,cmid=params.cmid||0,sesskey=params.sesskey||"",usedpeers=params.usedpeers||0,console.log("Students:",students),console.log("Initial peerAssignments:",peerAssignments);const numericPeers={};Object.keys(peerAssignments).forEach((function(key){numericPeers[parseInt(key)]=peerAssignments[key].map(Number)})),peerAssignments=numericPeers,console.log("After conversion peerAssignments:",peerAssignments),updateHiddenField(),$(document).off("change.peerassign",".add-peer-select"),$(document).on("change.peerassign",".add-peer-select",(function(){const userid=parseInt($(this).data("userid")),peerid=parseInt($(this).val());peerid&&addPeer(userid,peerid)})),$(document).off("click.peerassign",".remove-peer"),$(document).on("click.peerassign",".remove-peer",(function(e){e.preventDefault();const userid=parseInt($(this).data("userid")),peerid=parseInt($(this).data("peerid"));removePeer(userid,peerid)}));const courseBtn=$("#random-peers-course");courseBtn.length&&(courseBtn.off("click.peerassign"),courseBtn.on("click.peerassign",(function(e){e.preventDefault(),assignRandomPeers("course")})));const groupBtn=$("#random-peers-group");groupBtn.length&&(groupBtn.off("click.peerassign"),groupBtn.on("click.peerassign",(function(e){e.preventDefault(),assignRandomPeers("group")})));const form=$("form.mform");form.length&&(form.off("submit.peerassign"),form.on("submit.peerassign",(function(){updateHiddenField()})));const submitBtns=$('form.mform input[type="submit"]');submitBtns.length&&(submitBtns.off("click.peerassign"),submitBtns.on("click.peerassign",(function(){updateHiddenField()}))),console.log("Peer assignment initialization complete")}catch(error){console.error("Error initializing peer assignment:",error)}})}}}));
